# API設計ドキュメント

## 概要
本APIは、AWS LambdaおよびGoogle Cloud Run向けに同一のコードベースで動作するRustライブラリの共通抽象化レイヤーとして設計されています。actix-webに似た操作性を目指し、シンプルなルーティング定義やミドルウェアによる拡張、統一的なエラーハンドリングを提供します。

## 1. 共通APIインターフェース
- **エンドポイント登録:**  
  クライアントはシンプルなDSLまたはマクロを用いて、ルーティング定義を行います。
- **リクエスト/レスポンス処理:**  
  Lambda（API Gatewayイベント）やCloud Run（HTTPリクエスト）といった異なる入力形式を内部で共通の`Request`および`Response`型に統一します。
- **ミドルウェアサポート:**  
  認証、認可、ロギング、エラーハンドリングなどの機能をミドルウェアとして登録可能とし、各エンドポイントで利用されます。

## 2. 利用可能なエンドポイント例
### GET /
- **機能:** サービスのヘルスチェックおよびバージョン情報の返却  
- **説明:** サービス内部の基本状態や現在のバージョン情報を提供する簡易なエンドポイントです。

### GET /items
- **機能:** リソース（例：アイテム）の一覧取得  
- **説明:** 登録済みのアイテム情報をデータベースやキャッシュから取得し、一覧として返却します。

### POST /items
- **機能:** 新規リソースの作成  
- **説明:** リクエストボディに含まれる入力データをもとに、新たなアイテムを作成します。入力データのバリデーションとエラー処理も実施します。

### GET /items/{id}
- **機能:** 単一リソースの詳細取得  
- **説明:** パスパラメータとして指定された`id`に対応するアイテムの詳細情報を返却します。

### PUT /items/{id}
- **機能:** リソースの更新  
- **説明:** 指定された`id`のアイテム情報を、リクエストデータに基づいて更新します。バリデーションやエラーチェックも行います。

### DELETE /items/{id}
- **機能:** リソースの削除  
- **説明:** 特定の`id`を持つリソースを削除し、関連するデータのクリーンアップ処理を行います。

## 3. プラットフォームごとの実装特徴
### AWS Lambda向け (feature: lambda)
- **イベント変換:**  
  API Gatewayから送信されるLambdaイベントを、内部で共通の`Request`形式に変換します。
- **非同期処理:**  
  `lambda_runtime`や`aws_lambda_events`を活用し、非同期処理で効率的にリクエストを処理します。
- **リソース最適化:**  
  Lambdaのタイムアウトやリソース制約に配慮した実装を行い、安定した動作を確保します。

### Cloud Run向け (feature: cloud_run)
- **HTTPサーバ:**  
  actix-webや類似のHTTPサーバクレートを使用し、標準的なHTTPリクエストベースのエンドポイントを提供します。
- **ルーティングとミドルウェア:**  
  クライアントはシンプルなAPI定義でエンドポイントを登録でき、必要に応じたミドルウェアの設定が可能です。
- **スケーラビリティ:**  
  Cloud Runの特徴に合わせた負荷分散、リトライやキャッシュ連携など、拡張性を持った設計を採用します。

## 4. エラーハンドリングおよびロギング
- **統一的アプローチ:**  
  全エンドポイントに対して、共通のエラーハンドリングメカニズムを提供し、詳細なエラーメッセージを`log`クレートを用いて記録します。
- **ログ管理:**  
  ログレベルや出力先は環境変数等により柔軟にカスタマイズ可能です。

## 5. 開発者向けガイドと拡張性
- **シンプルなAPI登録:**  
  開発者はわかりやすいルーティング定義の仕組みを利用して、短いコードでエンドポイントを追加可能です。
- **拡張性:**  
  将来的には認証・認可機能、APIバージョン管理、Rate Limitingなどの機能を追加できるように設計されています。
- **テストとドキュメンテーション:**  
  各エンドポイントはユニットテストおよび統合テストで動作確認を行い、十分なドキュメントを整備します。

## 結論
この設計により、AWS LambdaとGoogle Cloud Runの両環境で共通のAPIインターフェースを提供しながら、プラットフォーム固有の違いを内部で吸収。開発者は統一されたインターフェースを用いることで、迅速かつ安全にサービスを構築できるようになります。